"use strict";(globalThis.webpackChunkctf_writeups=globalThis.webpackChunkctf_writeups||[]).push([[4184],{1403:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/insomnia-2-039be7acbae507428fdc8a2442168bca.png"},1601:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/medias/dbus-consultar-tiempos-12cdf4f7dda9c9d182cf3b7ef698372e.webm"},1885:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/proximas-llegadas-ae32e580600ea7cc2a2f8a759f5d39e6.png"},1933:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/notificacion-reloj-968c90281c367b9113d1df4075bfeeb4.png"},2326:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/select-desplegable-lineas-3b6d892e2586e2ff3263f16ff4ef6653.png"},2750:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/medias/dbus-bot-discord-5fb9140a8b6a6316a06bc315a2dd2a51.webm"},3289:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/select_paradas_1-eb4cf31274e7232e7008269d4a18cb74.png"},4777:e=>{e.exports=JSON.parse('{"permalink":"/blog/2026/01/24/creando-una-api-para-los-buses-de-mi-ciudad","editUrl":"https://github.com/KingJorjai/jorjai.net/tree/main/blog/2026-01-24/creando-una-api-para-los-buses-de-mi-ciudad.md","source":"@site/blog/2026-01-24/creando-una-api-para-los-buses-de-mi-ciudad.md","title":"Creando una API para los buses de mi ciudad","description":"\xa1Hola de nuevo a todxs! Durante esta semana me he hecho una lista en un Post-it con algunas ideas sobre los temas que me gustar\xeda tratar en pr\xf3ximas entradas del blog. Ahora que ha llegado el s\xe1bado, por fin tengo algo de tiempo para sentarme a escribir (t\xe9cnicamente llevo todo el d\xeda sentado, solo que he estado leyendo m\xe1s que escribiendo \ud83d\ude05).","date":"2026-01-24T00:00:00.000Z","tags":[{"inline":true,"label":"programaci\xf3n","permalink":"/blog/tags/programacion"},{"inline":true,"label":"javascript","permalink":"/blog/tags/javascript"},{"inline":true,"label":"nodejs","permalink":"/blog/tags/nodejs"},{"inline":true,"label":"express","permalink":"/blog/tags/express"},{"inline":true,"label":"puppeteer","permalink":"/blog/tags/puppeteer"},{"inline":true,"label":"api","permalink":"/blog/tags/api"},{"inline":true,"label":"web scraping","permalink":"/blog/tags/web-scraping"},{"inline":true,"label":"discord","permalink":"/blog/tags/discord"},{"inline":true,"label":"bot","permalink":"/blog/tags/bot"}],"readingTime":34.6,"hasTruncateMarker":true,"authors":[{"name":"Jorge Ar\xe9valo Fern\xe1ndez","title":"CTF Enthusiast & Security Researcher","url":"https://github.com/KingJorjai","socials":{"linkedin":"https://www.linkedin.com/in/jorge-ar\xe9valo-fern\xe1ndez/","github":"https://github.com/KingJorjai"},"imageURL":"/img/logo.gif","key":"jorjai","page":null}],"frontMatter":{"title":"Creando una API para los buses de mi ciudad","authors":"jorjai","tags":["programaci\xf3n","javascript","nodejs","express","puppeteer","api","web scraping","discord","bot"]},"unlisted":false,"nextItem":{"title":"Bienvenida al blog","permalink":"/blog/2026/01/17/bienvenida-al-blog"}}')},5627:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>u,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>p});var s=n(4777),r=n(4848),o=n(8453),i=n(1601),l=n(2750),t=n(5765);const d={title:"Creando una API para los buses de mi ciudad",authors:"jorjai",tags:["programaci\xf3n","javascript","nodejs","express","puppeteer","api","web scraping","discord","bot"]},c=void 0,u={authorsImageUrls:[void 0]},p=[{value:"El plan",id:"el-plan",level:2},{value:"Primera fase: Obtener los datos",id:"primera-fase-obtener-los-datos",level:2},{value:"Obteniendo las l\xedneas",id:"obteniendo-las-l\xedneas",level:3},{value:"Obteniendo las paradas",id:"obteniendo-las-paradas",level:3},{value:"Obteniendo los tiempos de llegada",id:"obteniendo-los-tiempos-de-llegada",level:3},{value:"El c\xf3digo de seguridad",id:"el-c\xf3digo-de-seguridad",level:4},{value:"Haciendo la petici\xf3n",id:"haciendo-la-petici\xf3n",level:4},{value:"Parseando la respuesta",id:"parseando-la-respuesta",level:4},{value:"Extrayendo el tiempo",id:"extrayendo-el-tiempo",level:4},{value:"Segunda fase: Crear la API",id:"segunda-fase-crear-la-api",level:2},{value:"Definiendo las rutas",id:"definiendo-las-rutas",level:3},{value:"Implementando los controladores",id:"implementando-los-controladores",level:3},{value:"Middleware (\xbfqu\xe9 diablos es eso?)",id:"middleware-qu\xe9-diablos-es-eso",level:3},{value:"Middleware de manejo de errores",id:"middleware-de-manejo-de-errores",level:4},{value:"Middleware de logging",id:"middleware-de-logging",level:4},{value:"La aplicaci\xf3n principal",id:"la-aplicaci\xf3n-principal",level:3},{value:"Probando la API",id:"probando-la-api",level:3},{value:"Tercera fase: Notificaciones en el m\xf3vil",id:"tercera-fase-notificaciones-en-el-m\xf3vil",level:2},{value:"Consultar la API desde el bot",id:"consultar-la-api-desde-el-bot",level:3},{value:"Recibiendo las notificaciones",id:"recibiendo-las-notificaciones",level:3},{value:"Conclusi\xf3n",id:"conclusi\xf3n",level:2},{value:"Sobre la falta de una API oficial",id:"sobre-la-falta-de-una-api-oficial",level:3},{value:"Gracias Joseba",id:"gracias-joseba",level:3}];function m(e){const a={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a.p,{children:"\xa1Hola de nuevo a todxs! Durante esta semana me he hecho una lista en un Post-it con algunas ideas sobre los temas que me gustar\xeda tratar en pr\xf3ximas entradas del blog. Ahora que ha llegado el s\xe1bado, por fin tengo algo de tiempo para sentarme a escribir (t\xe9cnicamente llevo todo el d\xeda sentado, solo que he estado leyendo m\xe1s que escribiendo \ud83d\ude05)."}),"\n",(0,r.jsxs)(a.p,{children:["Hoy me gustar\xeda hablar sobre un proyecto personal que comenc\xe9 en febrero del a\xf1o pasado (2025) a ra\xedz de una frustraci\xf3n: los ",(0,r.jsx)(a.strong,{children:"buses"})," que tengo que coger para volver a casa desde la universidad ",(0,r.jsx)(a.strong,{children:"nunca llegan a la hora"}),". Uno nunca sabe si va a llegar 5 minutos antes o 20 minutos despu\xe9s de lo previsto."]}),"\n",(0,r.jsxs)(a.p,{children:["Pero, \xa1no tem\xe1is! Porque el ayuntamiento ofrece una ",(0,r.jsx)(a.strong,{children:"aplicaci\xf3n para el m\xf3vil"})," que da los tiempos de llegada ",(0,r.jsx)(a.strong,{children:"en tiempo real"}),". ",(0,r.jsx)(a.em,{children:'"Entonces, \xbfcu\xe1l es el problema?"'}),", os preguntar\xe9is. Pues en realidad, ninguno. Solo que todos los d\xedas al final de la \xfaltima clase, tengo que sacar el m\xf3vil, abrir la app, buscar la parada, y mirar cu\xe1nto le queda a mi bus. Dependiendo de lo que ponga, s\xe9 si tengo que correr o no. Y yo no s\xe9 vosotrxs, pero si estudio ingenier\xeda es para que mi vida sea eficiente. Y no os voy a mentir, me da mucha pereza tener que hacer todo eso."]}),"\n",(0,r.jsxs)(a.p,{children:["As\xed que pens\xe9: ",(0,r.jsxs)(a.em,{children:['"No ser\xeda incre\xedble que me llegara un mensaje al m\xf3vil ',(0,r.jsx)(a.strong,{children:"justo"}),' cuando mi bus est\xe9 a 7 minutos de llegar?"']}),"."]}),"\n",(0,r.jsx)(a.h2,{id:"el-plan",children:"El plan"}),"\n",(0,r.jsxs)(a.p,{children:["Como buen ingeniero, lo primero que hice fue ",(0,r.jsx)(a.strong,{children:"dividir el problema en partes m\xe1s peque\xf1as"}),":"]}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.strong,{children:"Obtener los datos"})," de llegada de los buses en tiempo real"]}),"\n",(0,r.jsxs)(a.li,{children:["Crear una ",(0,r.jsx)(a.strong,{children:"API"})," que me permita consultar esos datos f\xe1cilmente"]}),"\n",(0,r.jsxs)(a.li,{children:["Hacer que me llegue una ",(0,r.jsx)(a.strong,{children:"notificaci\xf3n al m\xf3vil"})," cuando el bus est\xe9 a 7 minutos"]}),"\n"]}),"\n",(0,r.jsx)(a.p,{children:"Os voy avisando de que esta entrada va a ser un poco larga, porque me gustar\xeda explicar con detalle c\xf3mo consegu\xed hacer cada una de estas partes. As\xed que sin m\xe1s dilaci\xf3n, \xa1empecemos!"}),"\n",(0,r.jsx)(a.h2,{id:"primera-fase-obtener-los-datos",children:"Primera fase: Obtener los datos"}),"\n",(0,r.jsx)(a.p,{children:"Honestamente, esta parte fue la m\xe1s divertida de todas. All\xe1 vamos."}),"\n",(0,r.jsxs)(a.p,{children:["El servicio de buses tambi\xe9n publica los tiempos de llegada en ",(0,r.jsx)(a.a,{href:"https://dbus.eus/es/",children:"su p\xe1gina web"}),". Desde la p\xe1gina principal, seguimos los siguientes pasos:"]}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.strong,{children:"Elegir la l\xednea desde el desplegable"}),". Esto nos lleva a la p\xe1gina espec\xedfica de la l\xednea."]}),"\n",(0,r.jsxs)(a.li,{children:["En la p\xe1gina de la l\xednea, ",(0,r.jsx)(a.strong,{children:"elegir la parada desde otro desplegable"}),". Esto nos lleva a la p\xe1gina de la parada."]}),"\n",(0,r.jsxs)(a.li,{children:["En la p\xe1gina de la parada, podemos ver los tiempos de llegada de ",(0,r.jsx)(a.strong,{children:"cualquier l\xednea"})," que pase por esa parada. (Este es un detalle importante, ya que veremos m\xe1s l\xedneas adem\xe1s de la que nos interesa)."]}),"\n"]}),"\n",(0,r.jsx)("video",{src:i.A,autoPlay:!0,muted:!0,loop:!0,controls:!0,style:{maxWidth:"100%",height:"auto"}}),"\n",(0,r.jsx)(a.h3,{id:"obteniendo-las-l\xedneas",children:"Obteniendo las l\xedneas"}),"\n",(0,r.jsx)(a.p,{children:"El desplegable de selecci\xf3n de l\xednea muestra una lista con todas las l\xedneas de bus disponibles. As\xed que podemos parsear el HTML de la p\xe1gina principal para obtener esa lista."}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{alt:"Inspeccionando el c\xf3digo HTML de la p\xe1gina",src:n(2326).A+"",width:"1920",height:"1080"})}),"\n",(0,r.jsxs)(a.p,{children:["Sabemos que el desplegable tiene el atributo ",(0,r.jsx)(a.code,{children:'id="desplegable-lineas"'}),", as\xed que podemos buscar ese elemento en el DOM para obtener todas las opciones disponibles."]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-html",children:'<select id="desplegable-lineas" name="lineas">\n'})}),"\n",(0,r.jsxs)(a.p,{children:[(0,r.jsx)(a.em,{children:"\xbfQu\xe9 es el DOM?"})," Pues el Document Object Model, una representaci\xf3n estructurada del documento HTML que nos permite interactuar con \xe9l mediante JavaScript. No te preocupes, yo tampoco lo sab\xeda en ese momento. De hecho, fue la primera vez que us\xe9 JavaScript en serio. Cuando veamos la implementaci\xf3n, nos iremos familiarizando con los t\xe9rminos."]}),"\n",(0,r.jsx)(a.p,{children:"Si nos metemos al c\xf3digo fuente de la p\xe1gina, encontramos la siguiente funci\xf3n:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers=579 title="view-source:https://dbus.eus/es/"',children:'function get_lineas_front(){\n    lineas_front=JSON.parse(\'[{"texto":"05 | Benta Berri","valor":"1","enlace":"https:\\/\\/dbus.eus\\/05-benta-berri\\/"},{"texto":"08 | Gros-Intxaurrondo","valor":"7","enlace":"https:\\/\\/dbus.eus\\/08-gros-intxaurrondo\\/"},{"texto":"09 | Egia-Intxaurrondo","valor":"18","enlace":"https:\\/\\/dbus.eus\\/09-egia-intxaurrondo\\/"},{"texto":"13 | Altza ","valor":"19","enlace":"https:\\/\\/dbus.eus\\/13-altza\\/"},{"texto":"14 | Bidebieta","valor":"20","enlace":"https:\\/\\/dbus.eus\\/14-bidebieta\\/"},{"texto":"16 | Igeldo","valor":"10","enlace":"https:\\/\\/dbus.eus\\/16-igeldo\\/"},{"texto":"17 | Gros-Amara-Miramon","valor":"22","enlace":"https:\\/\\/dbus.eus\\/17-gros-amara-miramon\\/"},{"texto":"18 | Seminarioa","valor":"11","enlace":"https:\\/\\/dbus.eus\\/18-seminarioa\\/"},{"texto":"19 | Aiete-Bera Bera","valor":"12","enlace":"https:\\/\\/dbus.eus\\/19-aiete-bera-bera\\/"},{"texto":"21 | Amara-Mutualitateak","valor":"13","enlace":"https:\\/\\/dbus.eus\\/21-amara-mutualitateak\\/"},{"texto":"23 | Errondo-Puio","valor":"14","enlace":"https:\\/\\/dbus.eus\\/23-errondo-puio\\/"},{"texto":"24 | Altza-Gros-Antiguo-Intxaurrondo","valor":"23","enlace":"https:\\/\\/dbus.eus\\/24-altza-gros-antiguo-intxaurrondo\\/"},{"texto":"25 | BentaBerri-A\\u00f1orga","valor":"2","enlace":"https:\\/\\/dbus.eus\\/25-bentaberri-anorga\\/"},{"texto":"26 | Amara-Martutene","valor":"15","enlace":"https:\\/\\/dbus.eus\\/26-amara-martutene\\/"},{"texto":"27 | Altza-Intxaurrondo-Antiguo-Gros","valor":"24","enlace":"https:\\/\\/dbus.eus\\/27-altza-intxaurrondo-antiguo-gros\\/"},{"texto":"28 | Amara-Ospitaleak","valor":"16","enlace":"https:\\/\\/dbus.eus\\/28-amara-ospitaleak\\/"},{"texto":"29 | Intxaurrondo Sur","valor":"21","enlace":"https:\\/\\/dbus.eus\\/29-intxaurrondo-sur\\/"},{"texto":"31 | Intxaurrondo-Ospitaleak-Altza","valor":"25","enlace":"https:\\/\\/dbus.eus\\/31-intxaurrondo-ospitaleak-altza\\/"},{"texto":"32 | Puio-Errondo","valor":"17","enlace":"https:\\/\\/dbus.eus\\/32-puio-errondo\\/"},{"texto":"33 | Larratxo-Intxaur-Berio-Igara","valor":"26","enlace":"https:\\/\\/dbus.eus\\/33-larratxo-intxaurrondo-berio-igara\\/"},{"texto":"35 | Antiguo-Aiete-Ospitaleak","valor":"27","enlace":"https:\\/\\/dbus.eus\\/35-antiguo-aiete-ospitaleak\\/"},{"texto":"36 | Aldakonea-San Roke","valor":"30","enlace":"https:\\/\\/dbus.eus\\/36-aldakonea-san-roke\\/"},{"texto":"37 | Rodil-Zorroaga","valor":"39","enlace":"https:\\/\\/dbus.eus\\/37-rodil-zorroaga\\/"},{"texto":"38 | Trintxerpe-Altza-Molinao","valor":"40","enlace":"https:\\/\\/dbus.eus\\/38-trintxerpe-altza-molinao\\/"},{"texto":"39 | Urgull","valor":"41","enlace":"https:\\/\\/dbus.eus\\/39-urgull\\/"},{"texto":"40 | Gros-Antiguo-Igara","valor":"28","enlace":"https:\\/\\/dbus.eus\\/40-gros-antiguo-igara\\/"},{"texto":"41 | Gros-Egia-Martutene","valor":"29","enlace":"https:\\/\\/dbus.eus\\/41-gros-egia-martutene\\/"},{"texto":"42 | Aldapa-Egia","valor":"54","enlace":"https:\\/\\/dbus.eus\\/42-aldapa-egia\\/"},{"texto":"43 |\\u00a0Anoeta-Igara","valor":"43","enlace":"https:\\/\\/dbus.eus\\/43-anoeta-igara\\/"},{"texto":"45 | Estaciones Renfe-Bus Geltokiak-Antiguo-Aiete","valor":"56","enlace":"https:\\/\\/dbus.eus\\/45-estaciones-renfe-bus-geltokiak-antiguo-aiete\\/"},{"texto":"46 | San Antonio - Morlans","valor":"59","enlace":"https:\\/\\/dbus.eus\\/46-san-antonio-morlans\\/"},{"texto":"B1 | Benta Berri-Berio-A\\u00f1orga","valor":"31","enlace":"https:\\/\\/dbus.eus\\/b1-benta-berri-berio-anorga\\/"},{"texto":"B2 | Aiete-Bera Bera","valor":"32","enlace":"https:\\/\\/dbus.eus\\/b2-aiete-bera-bera\\/"},{"texto":"B3 | Egia-Intxaurrondo","valor":"33","enlace":"https:\\/\\/dbus.eus\\/b3-egia-intxaurrondo\\/"},{"texto":"B4 | Amara-Riberas-Martutene","valor":"34","enlace":"https:\\/\\/dbus.eus\\/b4-amara-riberas-martutene\\/"},{"texto":"B6 | Altza","valor":"35","enlace":"https:\\/\\/dbus.eus\\/b6-altza\\/"},{"texto":"B7 | Igeldo","valor":"36","enlace":"https:\\/\\/dbus.eus\\/b7-igeldo\\/"},{"texto":"B8 | Miraconcha-BentaBerri-Seminario","valor":"37","enlace":"https:\\/\\/dbus.eus\\/b8-miraconcha-bentaberri-seminario\\/"},{"texto":"B9 | Amara-Errondo-Puio","valor":"38","enlace":"https:\\/\\/dbus.eus\\/b9-amara-errondo-puio\\/"},{"texto":"B10 | Zubiaurre-Bidebieta-Buenavista","valor":"42","enlace":"https:\\/\\/dbus.eus\\/b10-zubiaurre-bidebieta-buenavista\\/"},{"texto":"Gautxorien aurreko zerbitzuak","valor":"52","enlace":"https:\\/\\/dbus.eus\\/pre-buhos-2\\/"},{"texto":"TB6 |\\u00a0Ulia Taxibusa","valor":"47","enlace":"https:\\/\\/dbus.eus\\/tb6-taxibus-ulia\\/"},{"texto":"TB7 | Atotxaerreka - Itsasargi Pasealeku Taxibusa","valor":"62","enlace":"https:\\/\\/dbus.eus\\/tb7-taxibus-atotxaerreka-paseo-del-faro-2\\/"},{"texto":"Zerbitzu berezia Anoetara (Futbola)","valor":"48","enlace":"https:\\/\\/www.dbus.eus\\/descargas\\/futbol-basket\\/servicios-especiales-anoeta-futbol_eu.pdf"},{"texto":"Illunbe \\u2013 erdialdea anezka zerbitzua","valor":"65","enlace":"https:\\/\\/dbus.eus\\/illunbe-erdialdea-anezka-zerbitzua\\/"},{"texto":"Linea aldaketen taula","valor":"51","enlace":"https:\\/\\/www.dbus.eus\\/descargas\\/transbordos.pdf "}]\');\n\n    var $desplegable_lineas=jQuery("#desplegable-lineas");\n    jQuery.each(lineas_front, function(k,v) {\n        jQuery("<option />", {value: v.valor, text: v.texto,enlace:v.enlace}).appendTo($desplegable_lineas);\n    });\n}\n'})}),"\n",(0,r.jsxs)(a.p,{children:["Aqu\xed vemos que la funci\xf3n ",(0,r.jsx)(a.code,{children:"get_lineas_front"})," crea un array de objetos JSON llamado ",(0,r.jsx)(a.code,{children:"lineas_front"}),", donde cada objeto representa una l\xednea de bus con su texto, valor y enlace. Luego, utiliza jQuery para seleccionar el elemento del DOM con el id ",(0,r.jsx)(a.code,{children:"desplegable-lineas"})," y a\xf1ade cada l\xednea como una opci\xf3n en el desplegable."]}),"\n",(0,r.jsx)(a.p,{children:"Jam\xe1s he visto semejante forma de definir datos en mi vida. Pero bueno, funciona. Como nosotros somos un poco m\xe1s elegantes, vamos a encontrar esa l\xednea usando regex y a extraer el array JSON directamente."}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:"showLineNumbers",children:"async function getBusLines() {\n    const response = await fetch('https://dbus.eus/es/');\n\n    if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n    }\n\n    const html = await response.text();\n\n    // Extraer el array JSON de la funci\xf3n get_lineas_front\n    const match = html.match(/lineas_front=JSON\\.parse\\('(.+?)'\\);/);\n    if (!match) {\n        throw new Error('Could not find lineas_front data in HTML');\n    }\n\n    // Reemplazar caracteres escapados y parsear el JSON\n    const jsonString = match[1].replace(/\\\\\\//g, '/').replace(/\\\\\"/g, '\"');\n    const linesData = JSON.parse(jsonString);\n\n    const options = linesData\n        .filter(item => item.texto && item.texto.includes('|'))\n        .map(item => {\n            // Manejar tanto espacios regulares como espacios no separables\n            // despu\xe9s de la barra vertical\n            const [code, name] = item.texto.split(/\\s*\\|\\s*/);\n            return {\n                code: code ? code.trim() : '',\n                name: name ? name.trim() : '',\n                url: item.enlace,\n                internal_id: item.valor\n            };\n        });\n\n    return options;\n}\n"})}),"\n",(0,r.jsx)(a.p,{children:"\xbfQu\xe9 hace exactamente este c\xf3digo? Vamos paso a paso:"}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:["\n",(0,r.jsxs)(a.p,{children:[(0,r.jsx)(a.strong,{children:"Obtener el HTML"}),": Primero hacemos una petici\xf3n HTTP a la p\xe1gina principal de dbus.eus usando ",(0,r.jsx)(a.code,{children:"fetch()"}),". Si la respuesta no es exitosa (c\xf3digo HTTP distinto de 2xx), lanzamos un error."]}),"\n"]}),"\n",(0,r.jsxs)(a.li,{children:["\n",(0,r.jsxs)(a.p,{children:[(0,r.jsx)(a.strong,{children:"Buscar el patr\xf3n con Regex"}),": Aqu\xed viene la parte interesante. Usamos una expresi\xf3n regular para buscar en todo el HTML la l\xednea donde se define ",(0,r.jsx)(a.code,{children:"lineas_front=JSON.parse('...')"}),". El patr\xf3n ",(0,r.jsx)(a.code,{children:"/lineas_front=JSON\\.parse\\('(.+?)'\\);/"})," captura todo lo que est\xe1 entre las comillas simples. El ",(0,r.jsx)(a.code,{children:"(.+?)"})," es un grupo de captura que obtiene el contenido del string JSON."]}),"\n"]}),"\n",(0,r.jsxs)(a.li,{children:["\n",(0,r.jsxs)(a.p,{children:[(0,r.jsx)(a.strong,{children:"Limpiar los caracteres escapados"}),": Como el JSON viene escapado dentro de un string de JavaScript (con ",(0,r.jsx)(a.code,{children:"\\/"})," en lugar de ",(0,r.jsx)(a.code,{children:"/"})," y ",(0,r.jsx)(a.code,{children:'\\"'})," en lugar de ",(0,r.jsx)(a.code,{children:'"'}),"), necesitamos reemplazar estos caracteres para obtener JSON v\xe1lido:"]}),"\n",(0,r.jsxs)(a.ul,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"replace(/\\\\\\//g, '/')"})," convierte ",(0,r.jsx)(a.code,{children:"\\/"})," en ",(0,r.jsx)(a.code,{children:"/"})]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"replace(/\\\\\"/g, '\"')"})," convierte ",(0,r.jsx)(a.code,{children:'\\"'})," en ",(0,r.jsx)(a.code,{children:'"'})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(a.li,{children:["\n",(0,r.jsxs)(a.p,{children:[(0,r.jsx)(a.strong,{children:"Procesar los datos"}),": Una vez tenemos el JSON parseado, lo transformamos para que sea m\xe1s f\xe1cil de usar:"]}),"\n",(0,r.jsxs)(a.ul,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:".filter()"}),' filtra solo las l\xedneas que tienen el formato "c\xf3digo | nombre" (descartando servicios especiales)']}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:".split(/\\s*\\|\\s*/)"})," separa el c\xf3digo del nombre usando la barra vertical como delimitador, ignorando espacios"]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:".map()"})," transforma cada elemento en un objeto m\xe1s limpio con propiedades descriptivas"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(a.p,{children:"El resultado es un array limpio y estructurado con todas las l\xedneas de bus:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-json",children:'[\n  {\n    "code": "05",\n    "name": "Benta Berri",\n    "url": "https://dbus.eus/05-benta-berri/",\n    "internal_id": "1"\n  },\n  {\n    "code": "08",\n    "name": "Gros-Intxaurrondo",\n    "url": "https://dbus.eus/08-gros-intxaurrondo/",\n    "internal_id": "7"\n  },\n  ...\n]\n'})}),"\n",(0,r.jsx)(a.p,{children:"\xa1Y listo! Ya tenemos la lista de l\xedneas de bus. En la siguiente secci\xf3n, veremos c\xf3mo obtener las paradas para una l\xednea espec\xedfica."}),"\n",(0,r.jsx)(a.h3,{id:"obteniendo-las-paradas",children:"Obteniendo las paradas"}),"\n",(0,r.jsx)(a.p,{children:"Ahora que tenemos la lista de l\xedneas, el siguiente paso es obtener las paradas de una l\xednea espec\xedfica. Por ejemplo, si quiero saber qu\xe9 paradas tiene la l\xednea 05, necesito ir a su p\xe1gina espec\xedfica."}),"\n",(0,r.jsxs)(a.p,{children:["Recordemos que cada l\xednea tiene una URL propia (como ",(0,r.jsx)(a.a,{href:"https://dbus.eus/05-benta-berri/",children:"https://dbus.eus/05-benta-berri/"}),"). Si accedemos a esa p\xe1gina, encontramos otro desplegable similar al anterior, pero esta vez con las paradas de esa l\xednea."]}),"\n",(0,r.jsxs)(a.p,{children:["Esta vez lo tenemos que hacer un poco diferente, porque la p\xe1gina de la l\xednea carga las paradas din\xe1micamente con JavaScript. No est\xe1n directamente en el HTML inicial como antes. Analizando el c\xf3digo fuente, vemos que las paradas se cargan en un ",(0,r.jsx)(a.code,{children:"<select>"})," con el id ",(0,r.jsx)(a.code,{children:"select_paradas_1"}),"."]}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{alt:"Inspeccionando el c\xf3digo HTML de la p\xe1gina",src:n(3289).A+"",width:"1920",height:"1080"})}),"\n",(0,r.jsx)(a.p,{children:"Echemos un vistazo al c\xf3digo fuente para entender c\xf3mo funciona. Resulta que las paradas no se generan de la misma manera que las l\xedneas. En lugar de estar hardcodeadas en el HTML, se cargan desde un archivo XML mediante una petici\xf3n AJAX:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers=560 title="view-source:https://dbus.eus/es/05-benta-berri/"',children:"jQuery.ajax({\n  url: '//dbus.eus/wp-content/uploads/wp-google-maps/3markers.xml?u='+UniqueCode,\n  async: false,\n  type: \"GET\",\n  success: function(data) {\n    jQuery(data).find(\"marker\").each(function(){\n      // Crear opci\xf3n en el select por cada parada\n      jQuery(\"<option />\", {\n        value: jQuery(this).find('parada_id').text(), \n        text: jQuery(this).find('title_eu').text()\n      }).appendTo(s);\n    });\n  }\n});\n"})}),"\n",(0,r.jsxs)(a.p,{children:["\xa1Interesante! Aqu\xed vemos que se hace una petici\xf3n AJAX a un archivo XML que contiene todas las paradas. Luego, por cada ",(0,r.jsx)(a.code,{children:"<marker>"})," en el XML, se crea una opci\xf3n en el desplegable con el id y el nombre de la parada. Dejo a continuaci\xf3n el primer marker del XML como ejemplo:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-xml",children:'<marker>\n    <marker_id>2</marker_id>\n    <map_id>3</map_id>\n    <title_es>34 | Boulevard 17</title_es>\n    <title_eu>34 | Boulevard 17</title_eu>\n    <title_en>34 | Boulevard 17</title_en>\n    <title_fr>34 | Boulevard 17</title_fr>\n    <parada_id>1587</parada_id>\n    <pto_turistico>0</pto_turistico>\n    <address>43.32214974,-1.983930094</address>\n    <desc_es>&lt;p&gt;Asociada a las l&#xED;neas &lt;a title="05 | Benta Berri" href="https://www.dbus.eus/es/05-benta-berri/"&gt;05&lt;/a&gt;, &lt;a title="25 | BentaBerri-A&#xF1;orga" href="https://www.dbus.eus/es/25-bentaberri-anorga/"&gt;25&lt;/a&gt;, &lt;a title="B1 | Benta Berri-Berio-A&#xF1;orga" href="https://www.dbus.eus/es/b1-benta-berri-berio-anorga/"&gt;B1&lt;/a&gt;, &lt;a title="B8 | Miraconcha-Benta Berri-Seminario" href="https://www.dbus.eus/es/b8-miraconcha-benta-berri-seminario/"&gt;B8&lt;/a&gt;&lt;/p&gt;</desc_es>\n    <desc_eu>&lt;p&gt;&lt;b&gt;&lt;/b&gt;Linea hauekin erlazionatuta &lt;a title="05 | Benta Berri" href="https://www.dbus.eus/05-benta-berri/"&gt;05&lt;/a&gt;, &lt;a title="25 | BentaBerri-A&#xF1;orga" href="https://www.dbus.eus/25-bentaberri-anorga/"&gt;25&lt;/a&gt;, &lt;a title="B1 | Benta Berri-Berio-A&#xF1;orga" href="https://www.dbus.eus/b1-benta-berri-berio-anorga/"&gt;B1&lt;/a&gt;, &lt;a title="B8 | Miraconcha-Benta Berri-Seminario" href="https://www.dbus.eus/b8-miraconcha-benta-berri-seminario/"&gt;B8&lt;/a&gt;&lt;/p&gt;</desc_eu>\n    <desc_en>&lt;p&gt;&lt;b&gt;Asociada&lt;/b&gt; a las l&#xED;neas &lt;a title="L&#xED;nea 5" href="http://www.dbus.eus/linea-5/"&gt;05&lt;/a&gt;, &lt;a title="Linea 25" href="http://www.dbus.eus/linea-25/"&gt;25&lt;/a&gt;&lt;br /&gt; Horarios de paso por parada(en)&lt;/p&gt;</desc_en>\n    <desc_fr>&lt;p&gt;&lt;b&gt;Asociada&lt;/b&gt; a las l&#xED;neas &lt;a title="L&#xED;nea 5" href="http://www.dbus.eus/linea-5/"&gt;05&lt;/a&gt;, &lt;a title="Linea 25" href="http://www.dbus.eus/linea-25/"&gt;25&lt;/a&gt;&lt;br /&gt; Horarios de paso por parada(fr3)&lt;/p&gt;</desc_fr>\n    <pic></pic>\n    <icon>https://www.dbus.eus/wp-content/uploads/2014/03/05.png</icon>\n    <linkd></linkd>\n    <lat>43.32214974</lat>\n    <lng>-1.983930094</lng>\n    <anim>0</anim>\n    <category>1</category>\n    <infoopen>0</infoopen>\n  </marker>\n'})}),"\n",(0,r.jsxs)(a.p,{children:["Lo ideal ser\xeda hacer una petici\xf3n AJAX similar para obtener las paradas. Sin embargo, tras mirar la p\xe1gina de cada l\xednea, me di cuenta de que cada una hac\xeda referencia a un archivo XML diferente, con un par\xe1metro \xfanico en la URL. Por ejemplo, la l\xednea 05 usa ",(0,r.jsx)(a.code,{children:"3markers.xml"}),", mientras que la l\xednea 08 usa ",(0,r.jsx)(a.code,{children:"11markers.xml"}),". Esto complicaba un poco las cosas, ya que no hab\xeda una forma directa de saber qu\xe9 archivo XML correspond\xeda a cada l\xednea sin inspeccionar el c\xf3digo fuente de cada p\xe1gina. Tal vez en un futuro me moleste en entender c\xf3mo se asignan esos n\xfameros, pero como necesitaba un prototipo r\xe1pido, hice un apa\xf1o un poco sucio."]}),"\n",(0,r.jsxs)(a.p,{children:["Al ejecutarse el c\xf3digo JavaScript en un cliente real, el archivo XML se carga correctamente y las paradas se muestran en el desplegable. As\xed que lo que hice fue ",(0,r.jsx)(a.strong,{children:"simular la ejecuci\xf3n del JavaScript"})," para obtener el HTML final con las paradas ya cargadas. Esto lo logr\xe9 usando una librer\xeda llamada ",(0,r.jsx)(a.strong,{children:"Puppeteer"}),", que nos permite controlar un navegador desde nuestro c\xf3digo."]}),"\n",(0,r.jsx)(a.admonition,{type:"note",children:(0,r.jsx)(a.p,{children:"Lo s\xe9, lo s\xe9. Es un poco exagerado usar un navegador completo solo para obtener unas paradas. Pero funcion\xf3, y era r\xe1pido de implementar. (Aunque esto trajo sus propios problemas, como veremos m\xe1s adelante)."})}),"\n",(0,r.jsx)(a.p,{children:"Vamos a ver c\xf3mo funciona el proceso paso a paso:"}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.strong,{children:"1. Buscar la informaci\xf3n de la l\xednea"})}),"\n",(0,r.jsxs)(a.p,{children:["Primero necesitamos saber la URL de la l\xednea. Para esto, usamos la funci\xf3n que creamos anteriormente (",(0,r.jsx)(a.code,{children:"getBusLines()"}),") que obtiene todas las l\xedneas disponibles. Buscamos la l\xednea que coincida con el c\xf3digo que nos interesa:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:"showLineNumbers=3",children:'const allLines = await getBusLines();\nconst lineInfo = allLines.find(line => line.code === lineCode);\n\nif (!lineInfo) {\n    throw new Error(`Line ${lineCode} not found`);\n}\n\n// Ahora tenemos lineInfo.url, por ejemplo: "https://dbus.eus/05-benta-berri/"\n'})}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.strong,{children:"2. Abrir el navegador y navegar a la p\xe1gina"})}),"\n",(0,r.jsx)(a.p,{children:"Con Puppeteer, lanzamos un navegador headless (sin interfaz gr\xe1fica) y abrimos la URL de la l\xednea:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:"showLineNumbers=11",children:"const browser = await puppeteer.launch({ headless: true });\nconst page = await browser.newPage();\nawait page.goto(lineInfo.url, { waitUntil: 'networkidle0' });\n"})}),"\n",(0,r.jsxs)(a.p,{children:["La opci\xf3n ",(0,r.jsx)(a.code,{children:"waitUntil: 'networkidle0'"})," le dice al navegador que espere hasta que no haya m\xe1s peticiones de red activas, lo que asegura que el JavaScript se haya ejecutado completamente."]}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.strong,{children:"3. Manejar las cookies"})}),"\n",(0,r.jsx)(a.p,{children:"Muchas p\xe1ginas web muestran un banner de cookies. Si no lo aceptamos, puede que algunos elementos no carguen correctamente:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:"showLineNumbers=16",children:"// Intentar aceptar las cookies si aparece el banner\ntry {\n    await page.click('#cookie-accept-button', { timeout: 2000 });\n    await page.reload({ waitUntil: 'networkidle0' });\n} catch (e) {\n    // Si no hay banner de cookies, continuamos\n}\n"})}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.strong,{children:"4. Esperar a que aparezca el selector de paradas"})}),"\n",(0,r.jsxs)(a.p,{children:["El desplegable de paradas tiene el id ",(0,r.jsx)(a.code,{children:"select_paradas_1"}),". Esperamos a que este elemento aparezca en el DOM:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:"showLineNumbers=24",children:"await page.waitForSelector('#select_paradas_1', { timeout: 10000 });\n"})}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.strong,{children:"5. Extraer las opciones del desplegable"})}),"\n",(0,r.jsxs)(a.p,{children:["Una vez que el selector est\xe1 presente, podemos extraer todas sus opciones. Usamos ",(0,r.jsx)(a.code,{children:"page.evaluate()"})," para ejecutar c\xf3digo JavaScript dentro del contexto de la p\xe1gina:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:"showLineNumbers=27",children:"const stops = await page.evaluate(() => {\n    const selectElement = document.querySelector('#select_paradas_1');\n    const options = Array.from(selectElement.options);\n    \n    return options\n        .filter(option => option.value && option.text.includes('|'))\n        .map(option => {\n            const [code, name] = option.text.split(/\\s*\\|\\s*/);\n            return {\n                code: code ? code.trim() : '',\n                name: name ? name.trim() : '',\n                internal_id: option.value\n            };\n        });\n});\n"})}),"\n",(0,r.jsxs)(a.p,{children:["Este c\xf3digo se ejecuta en el navegador (no en Node.js), por eso podemos usar ",(0,r.jsx)(a.code,{children:"document.querySelector"}),". Extrae todas las opciones del ",(0,r.jsx)(a.code,{children:"<select>"}),', filtra las que tienen el formato "c\xf3digo | nombre", y devuelve un array estructurado.']}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.strong,{children:"6. Cerrar el navegador"})}),"\n",(0,r.jsx)(a.p,{children:"Importante no olvidarse de esto para liberar recursos:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:"showLineNumbers=44",children:"await browser.close();\n"})}),"\n",(0,r.jsx)(a.p,{children:"Junt\xe1ndolo todo, la funci\xf3n completa quedar\xeda as\xed:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:"showLineNumbers",children:"async function getBusStops(lineCode) {\n    // 1. Buscar la informaci\xf3n de la l\xednea\n    const allLines = await getBusLines();\n    const lineInfo = allLines.find(line => line.code === lineCode);\n\n    if (!lineInfo) {\n        throw new Error(`Line ${lineCode} not found`);\n    }\n\n    // 2. Abrir el navegador y navegar a la p\xe1gina\n    const browser = await puppeteer.launch({ headless: true });\n    const page = await browser.newPage();\n    await page.goto(lineInfo.url, { waitUntil: 'networkidle0' });\n\n    // 3. Manejar las cookies\n    try {\n        await page.click('#cookie-accept-button', { timeout: 2000 });\n        await page.reload({ waitUntil: 'networkidle0' });\n    } catch (e) {\n        // Si no hay banner de cookies, continuamos\n    }\n\n    // 4. Esperar a que aparezca el selector de paradas\n    await page.waitForSelector('#select_paradas_1', { timeout: 10000 });\n\n    // 5. Extraer las opciones del desplegable\n    const stops = await page.evaluate(() => {\n        const selectElement = document.querySelector('#select_paradas_1');\n        const options = Array.from(selectElement.options);\n        \n        return options\n            .filter(option => option.value && option.text.includes('|'))\n            .map(option => {\n                const [code, name] = option.text.split(/\\s*\\|\\s*/);\n                return {\n                    code: code ? code.trim() : '',\n                    name: name ? name.trim() : '',\n                    internal_id: option.value\n                };\n            });\n    });\n\n    // 6. Cerrar el navegador\n    await browser.close();\n\n    return stops;\n}\n"})}),"\n",(0,r.jsx)(a.p,{children:"Y voil\xe0! Tenemos nuestras paradas:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-json",children:'[\n  {\n    "code": "34",\n    "name": "Boulevard 17",\n    "internal_id": "1587"\n  },\n  {\n    "code": "35",\n    "name": "Urbieta 20",\n    "internal_id": "1590"\n  },\n  ...\n]\n'})}),"\n",(0,r.jsxs)(a.p,{children:["El proceso completo tarda unos 3-5 segundos por l\xednea, lo cual no est\xe1 mal para un prototipo. Aunque como mencion\xe9 antes, usar un navegador completo solo para extraer datos de un ",(0,r.jsx)(a.code,{children:"<select>"}),' es un poco overkill. Pero cuando est\xe1s aprendiendo y necesitas que algo funcione r\xe1pido, a veces "lo que funciona" es mejor que "lo perfecto".']}),"\n",(0,r.jsxs)(a.p,{children:["A todo esto, nunca hab\xeda usado Puppeteer antes, as\xed que aprovech\xe9 que ten\xeda ",(0,r.jsx)(a.strong,{children:"Copilot"})," en VSCode para ir pidi\xe9ndole lo que necesitaba y dejando que me lo implementara. Me ahorr\xe9 mucho tiempo de estar buscando ",(0,r.jsx)(a.em,{children:'"C\xf3mo hacer X con Puppeteer"'})," en Google. Tambi\xe9n lo utilic\xe9 para ",(0,r.jsx)(a.strong,{children:"generar las expresiones regulares"})," (yo sigo sin saber c\xf3mo hay humanos capaces de crear esos patrones por s\xed mismos)."]}),"\n",(0,r.jsx)(a.h3,{id:"obteniendo-los-tiempos-de-llegada",children:"Obteniendo los tiempos de llegada"}),"\n",(0,r.jsx)(a.p,{children:"Ya casi tenemos todo lo necesario. Ahora mismo contamos con la lista de l\xedneas y con una lista de paradas para cada l\xednea. El \xfaltimo paso es obtener los tiempos de llegada en tiempo real para una parada espec\xedfica."}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{alt:"Cuadro con los tiempos de llegada de la parada 34 - Boulevard 17",src:n(1885).A+"",width:"622",height:"379"})}),"\n",(0,r.jsxs)(a.p,{children:["Tenemos un bot\xf3n muy \xfatil que dice ",(0,r.jsx)(a.em,{children:'"Volver a consultar tiempos"'}),". Si inspeccionamos qu\xe9 hace este bot\xf3n cuando lo pulsamos, veremos que llama a una funci\xf3n JavaScript llamada ",(0,r.jsx)(a.code,{children:"calcula_parada"}),". Aqu\xed est\xe1 el c\xf3digo relevante:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers=2171 title="view-source:https://dbus.eus/es/05-benta-berri/"',children:'jQuery("body").on("click", "#brecalcular_fecha", function() {\n    var dia = new Date().getDate();\n    var mes = new Date().getMonth() + 1;\n    var year = new Date().getFullYear();\n    var hora = new Date().getHours() + 100;\n        hora = hora.toString().substring(1);\n    var minutos = new Date().getMinutes() + 100;\n        minutos = minutos.toString().substring(1);\n    var parada_id = jQuery("#select_paradas").find(":selected").val();\n    var linea = \'05\';\n    \n    calcula_parada(linea, parada_id, dia, mes, year, hora, minutos);\n});\n'})}),"\n",(0,r.jsxs)(a.admonition,{type:"tip",children:[(0,r.jsxs)(a.p,{children:["Hay algo curioso aqu\xed: ese truco para formatear las horas y minutos. En lugar de usar ",(0,r.jsx)(a.code,{children:"padStart(2, '0')"})," (que probablemente no exist\xeda o no conoc\xedan cuando escribieron esto), suman 100 al n\xfamero. Por ejemplo, si son las 14:05:"]}),(0,r.jsxs)(a.ul,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"14 + 100 = 114"})," \u2192 ",(0,r.jsx)(a.code,{children:".substring(1)"})," \u2192 ",(0,r.jsx)(a.code,{children:'"14"'})]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"5 + 100 = 105"})," \u2192 ",(0,r.jsx)(a.code,{children:".substring(1)"})," \u2192 ",(0,r.jsx)(a.code,{children:'"05"'})]}),"\n"]}),(0,r.jsx)(a.p,{children:"Ingenioso, aunque un poco oscuro. Pero funciona."})]}),"\n",(0,r.jsxs)(a.p,{children:["La funci\xf3n ",(0,r.jsx)(a.code,{children:"calcula_parada"})," hace una petici\xf3n AJAX para obtener los tiempos de llegada:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers=2056 title="view-source:https://dbus.eus/es/05-benta-berri/"',children:'function calcula_parada(linea, parada_id, dia, mes, year, hora, minuto) {\n    var data = {\n        action: \'calcula_parada\',\n        security: \'bae19310a6\',\n        linea: linea,\n        parada: parada_id,\n        dia: dia,\n        mes: mes,\n        year: year,\n        hora: hora,\n        minuto: minuto\n    };\n    \n    var ajaxurl = "https://dbus.eus/wp-admin/admin-ajax.php";\n    \n    jQuery.ajax({\n        type: \'POST\',\n        url: ajaxurl,\n        data: data,\n        success: function(result) {\n            jQuery("#consulta_horarios").html(result);\n            jQuery("#proximas_llegadas").html(jQuery("#prox_lle").html());\n            jQuery("#consulta_horarios").find("#prox_lle").remove();\n            // ... m\xe1s c\xf3digo para configurar el datepicker y timepicker\n        },\n        async: true\n    });\n}\n'})}),"\n",(0,r.jsxs)(a.p,{children:["\xa1Perfecto! Esto significa que podemos hacer la misma petici\xf3n desde nuestro c\xf3digo para obtener los tiempos de llegada. Pero hay un detalle importante: el par\xe1metro ",(0,r.jsx)(a.code,{children:"security"}),"."]}),"\n",(0,r.jsx)(a.h4,{id:"el-c\xf3digo-de-seguridad",children:"El c\xf3digo de seguridad"}),"\n",(0,r.jsx)(a.p,{children:"Este c\xf3digo de seguridad es un mecanismo para prevenir peticiones no autorizadas. Si miramos el c\xf3digo fuente de la p\xe1gina de cada l\xednea, podemos encontrarlo en uno de los scripts:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",children:"security: 'a1b2c3d4e5'\n"})}),"\n",(0,r.jsx)(a.p,{children:"Este c\xf3digo cambia peri\xf3dicamente, as\xed que necesitamos extraerlo cada vez que visitamos la p\xe1gina. Por suerte, ya estamos usando Puppeteer para obtener las paradas, as\xed que podemos aprovechar para extraer este c\xf3digo al mismo tiempo."}),"\n",(0,r.jsxs)(a.p,{children:["Dentro del navegador, buscamos en todos los ",(0,r.jsx)(a.code,{children:"<script>"})," de la p\xe1gina el que contiene la palabra ",(0,r.jsx)(a.code,{children:"security"}),":"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",children:"const securityCode = await page.evaluate(() => {\n    const scriptTags = Array.from(document.querySelectorAll('script'));\n    \n    for (const script of scriptTags) {\n        if (script.textContent.includes('security')) {\n            const match = script.textContent.match(/security:\\s*'(\\w+)'/);\n            if (match) {\n                return match[1];\n            }\n        }\n    }\n    return null;\n});\n"})}),"\n",(0,r.jsx)(a.p,{children:"Una vez que tenemos el c\xf3digo de seguridad, podemos hacer la petici\xf3n para obtener los tiempos."}),"\n",(0,r.jsx)(a.h4,{id:"haciendo-la-petici\xf3n",children:"Haciendo la petici\xf3n"}),"\n",(0,r.jsx)(a.p,{children:"Con todos los ingredientes listos, construimos la petici\xf3n POST:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",children:"async function getBusTimeAtStop(lineNumber, stopCode) {\n    // 1. Obtener las paradas de la l\xednea y encontrar la espec\xedfica\n    const stops = await getBusStops(lineNumber);\n    const stop = stops.find(s => s.code === stopCode);\n\n    if (!stop) {\n        throw new Error(`Stop ${stopCode} not found`);\n    }\n\n    // 2. Construir los par\xe1metros de la petici\xf3n con la fecha/hora actual\n    const now = new Date();\n    const params = {\n        action: 'calcula_parada',\n        security: securityCode,  // El que extrajimos antes\n        linea: lineNumber.toString(),\n        parada: stop.internal_id,\n        dia: now.getDate().toString().padStart(2, '0'),\n        mes: (now.getMonth() + 1).toString().padStart(2, '0'),\n        year: now.getFullYear().toString(),\n        hora: now.getHours().toString().padStart(2, '0'),\n        minuto: now.getMinutes().toString().padStart(2, '0')\n    };\n\n    // 3. Hacer la petici\xf3n POST\n    const response = await fetch('https://dbus.eus/wp-admin/admin-ajax.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: new URLSearchParams(params)\n    });\n\n    const html = await response.text();\n    \n    // 4. Parsear la respuesta...\n}\n"})}),"\n",(0,r.jsx)(a.h4,{id:"parseando-la-respuesta",children:"Parseando la respuesta"}),"\n",(0,r.jsx)(a.p,{children:"La respuesta que recibimos es HTML que contiene una lista con los tiempos de llegada de todas las l\xedneas que pasan por esa parada:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-html",children:'<div id="prox_lle">\n    <ul>\n        <li>Linea 5: 14:35 (5 min)</li>\n        <li>Linea 25: 14:42 (12 min)</li>\n        <li>Linea 5: 14:50 (20 min)</li>\n    </ul>\n</div>\n'})}),"\n",(0,r.jsxs)(a.p,{children:["Necesitamos parsear este HTML y extraer solo el tiempo de la l\xednea que nos interesa. Para eso usamos ",(0,r.jsx)(a.code,{children:"jsdom"}),", una librer\xeda que nos permite manipular HTML en Node.js como si estuvi\xe9ramos en un navegador:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",children:"import { JSDOM } from 'jsdom';\n\nfunction parseTimeResponse(html, lineNumber) {\n    const dom = new JSDOM(html);\n    const doc = dom.window.document;\n\n    // Obtener todos los elementos de la lista\n    const listItems = Array.from(doc.querySelectorAll('#prox_lle ul li'))\n        .map(item => item.textContent.trim());\n    \n    // Buscar el que corresponde a nuestra l\xednea\n    const requestedLine = listItems.find(item => \n        item.includes(`Linea ${parseInt(lineNumber, 10)}:`)\n    );\n\n    if (!requestedLine) {\n        throw new Error('Bus time not found');\n    }\n\n    // Extraer el tiempo del texto\n    return extractTimeFromText(requestedLine);\n}\n"})}),"\n",(0,r.jsx)(a.h4,{id:"extrayendo-el-tiempo",children:"Extrayendo el tiempo"}),"\n",(0,r.jsx)(a.p,{children:"El texto puede venir en dos formatos:"}),"\n",(0,r.jsxs)(a.ul,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:'"14:35"'})," - hora exacta de llegada"]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:'"5 min"'})," - minutos restantes para la llegada"]}),"\n"]}),"\n",(0,r.jsx)(a.p,{children:"Necesitamos extraer los minutos que faltan para que llegue el bus:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",children:"function extractTimeFromText(timeText) {\n    // Intentar capturar formato \"HH:MM\"\n    const timeMatch = timeText.match(/(\\d{2}:\\d{2})/);\n    \n    if (timeMatch) {\n        // Calcular cu\xe1nto tiempo falta\n        const now = new Date();\n        const [hours, minutes] = timeMatch[1].split(':').map(Number);\n        const busTime = new Date(now.getFullYear(), now.getMonth(), \n                                  now.getDate(), hours, minutes);\n        \n        const timeDiff = busTime - now;\n        const minutesDiff = Math.floor(timeDiff / 60000);\n        return Math.max(0, minutesDiff);\n    }\n    \n    // Intentar capturar formato \"X min\"\n    const minutesMatch = timeText.match(/(\\d+)\\s*min/);\n    if (minutesMatch) {\n        return parseInt(minutesMatch[1], 10);\n    }\n\n    throw new Error('Bus time format not recognized');\n}\n"})}),"\n",(0,r.jsx)(a.p,{children:"\xa1Y con esto ya tenemos todo! La funci\xf3n completa nos devuelve el n\xfamero de minutos que faltan para que llegue nuestro bus. Escribir esta parte del blog me ha llevado un par de horas, no recordaba haber trabajado tanto cuando lo program\xe9 hace un a\xf1o. Pero qu\xe9 se le va a hacer. Ahora que ya podemos obtener toda la informaci\xf3n que necesitamos, en la siguiente secci\xf3n veremos c\xf3mo montar todo esto en una API."}),"\n",(0,r.jsx)(a.h2,{id:"segunda-fase-crear-la-api",children:"Segunda fase: Crear la API"}),"\n",(0,r.jsxs)(a.p,{children:["Aqu\xed no me compliqu\xe9 mucho. Busqu\xe9 ",(0,r.jsx)(a.em,{children:'"C\xf3mo crear una API en Node.js"'})," en Google, y todos los tutoriales que encontr\xe9 usaban ",(0,r.jsx)(a.strong,{children:"Express.js"}),". As\xed que instal\xe9 Express y me puse manos a la obra."]}),"\n",(0,r.jsx)(a.h3,{id:"definiendo-las-rutas",children:"Definiendo las rutas"}),"\n",(0,r.jsxs)(a.p,{children:["Express funciona con un sistema de rutas. En ",(0,r.jsx)(a.code,{children:"index.js"})," definimos las rutas que queremos exponer en nuestra API. Mi idea para estructurar la informaci\xf3n es la siguiente:"]}),"\n",(0,r.jsxs)(a.ul,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"GET /lines"})," Devuelve la lista de l\xedneas de bus"]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"GET /lines/:lineCode"})," Devuelve las paradas de una l\xednea espec\xedfica"]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"GET /lines/:lineCode/:stopCode"})," Devuelve el tiempo de llegada de esa l\xednea en esa parada"]}),"\n"]}),"\n",(0,r.jsxs)(a.p,{children:["Nuestro archivo ",(0,r.jsx)(a.code,{children:"index.js"})," queda as\xed:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers title="index.js"',children:"import { Router } from 'express';\nimport linesRouter from './lines.js';\n\nconst router = Router();\n\nrouter.use('/lines', linesRouter);\n\nexport default router;\n"})}),"\n",(0,r.jsx)(a.p,{children:"Analizo el c\xf3digo por partes, aunque es bastante sencillo."}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:["Importamos el router de Express y el router espec\xedfico para las l\xedneas (",(0,r.jsx)(a.code,{children:"linesRouter"}),")."]}),"\n",(0,r.jsx)(a.li,{children:"Creamos una instancia del router principal."}),"\n",(0,r.jsxs)(a.li,{children:["Usamos ",(0,r.jsx)(a.code,{children:"router.use('/lines', linesRouter);"})," para decir que todas las peticiones que comiencen con ",(0,r.jsx)(a.code,{children:"/lines"})," deben ser manejadas por el router ",(0,r.jsx)(a.code,{children:"linesRouter"}),"."]}),"\n",(0,r.jsx)(a.li,{children:"Finalmente, exportamos el router principal para que pueda ser usado en nuestro servidor Express."}),"\n"]}),"\n",(0,r.jsxs)(a.p,{children:["De esta forma, ",(0,r.jsx)(a.code,{children:"index"})," serve como punto de entrada y delega todas las peticiones que comienzan con ",(0,r.jsx)(a.code,{children:"/lines"})," al router definido en ",(0,r.jsx)(a.code,{children:"lines.js"}),". Para lo simple que es la API que estamos construyendo, podr\xedamos haber gestionado todas las rutas directamente en ",(0,r.jsx)(a.code,{children:"index.js"}),", pero es una buena pr\xe1ctica separar las rutas en m\xf3dulos diferentes para mantener el c\xf3digo organizado."]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers title="lines.js"',children:"import { Router } from 'express';\nimport lineController from '../../../controllers/lineController.js';\nimport stopController from '../../../controllers/stopController.js';\n\nconst router = Router();\n\n// Get all bus lines\nrouter.get('/', lineController.getLines);\n\n// Get stops for a specific line\nrouter.get('/:lineCode', lineController.getLineStops);\n\n// Get bus arrival time for a specific stop in a line\nrouter.get('/:lineCode/:stopCode', stopController.getBusArrival);\n\nexport default router;\n"})}),"\n",(0,r.jsx)(a.p,{children:"En el router de las l\xedneas, tenemos lo siguiente:"}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:["Importamos el router de Express y los controladores que manejar\xe1n la l\xf3gica de las peticiones (",(0,r.jsx)(a.code,{children:"lineController"})," y ",(0,r.jsx)(a.code,{children:"stopController"}),")."]}),"\n",(0,r.jsx)(a.li,{children:"Creamos una instancia del router espec\xedfico para las l\xedneas."}),"\n",(0,r.jsxs)(a.li,{children:["Definimos las rutas:","\n",(0,r.jsxs)(a.ul,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"GET /"})," llama a ",(0,r.jsx)(a.code,{children:"lineController.getLines"})," para obtener todas las l\xedneas de bus."]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"GET /:lineCode"})," llama a ",(0,r.jsx)(a.code,{children:"lineController.getLineStops"})," para obtener las paradas de una l\xednea espec\xedfica."]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"GET /:lineCode/:stopCode"})," llama a ",(0,r.jsx)(a.code,{children:"stopController.getBusArrival"})," para obtener el tiempo de llegada del bus en una parada espec\xedfica."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(a.li,{children:"Exportamos el router para que pueda ser usado en `index.js"}),"\n"]}),"\n",(0,r.jsx)(a.p,{children:"Como veis, realmente es el router de las l\xedneas el que expone los endpoints. Cada endpoint llama a un controlador diferente que contiene la l\xf3gica para manejar la petici\xf3n. Vamos a ver cada uno de ellos."}),"\n",(0,r.jsx)(a.h3,{id:"implementando-los-controladores",children:"Implementando los controladores"}),"\n",(0,r.jsx)(a.p,{children:"Estos controladores son los que hacen el trabajo sucio. Llaman a las funciones que hemos creado anteriormente para obtener los datos y devuelven la respuesta en formato JSON. Todo mascadito para que Express lo publique directamente."}),"\n",(0,r.jsxs)(a.p,{children:["El controlador de l\xedneas (",(0,r.jsx)(a.code,{children:"lineController.js"}),") va a ser el encargado de manejar las peticiones ",(0,r.jsx)(a.code,{children:"GET /lines"})," y ",(0,r.jsx)(a.code,{children:"GET /lines/:lineCode"}),"."]}),"\n",(0,r.jsx)(a.p,{children:"Aqu\xed est\xe1 su implementaci\xf3n:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers title="lineController.js"',children:"import scraperService from '../services/scraperService.js';\n\nexport class LineController {\n    async getLines(req, res, next) {\n        try {\n            // highlight-next-line\n            const busLines = await scraperService.getBusLines();\n            res.json({\n                success: true,\n                data: busLines,\n                count: busLines.length\n            });\n        } catch (error) {\n            next(error);\n        }\n    }\n\n    async getLineStops(req, res, next) {\n        try {\n            const { lineCode } = req.params;\n            // highlight-next-line\n            const busStops = await scraperService.getLineStops(lineCode);\n            \n            res.json({\n                success: true,\n                data: busStops\n            });\n        } catch (error) {\n            next(error);\n        }\n    }\n}\n\nexport default new LineController();\n"})}),"\n",(0,r.jsxs)(a.p,{children:["He metido las funciones que dise\xf1amos en la primera parte dentro de un servicio llamado ",(0,r.jsx)(a.code,{children:"scraperService"}),". As\xed, el controlador solo se encarga de recibir la petici\xf3n, llamar al servicio para obtener los datos y devolver la respuesta en formato JSON. F\xe1cil, sencillo, y para toda la familia."]}),"\n",(0,r.jsx)(a.p,{children:"El c\xf3digo paso a paso:"}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:["Importamos el servicio ",(0,r.jsx)(a.code,{children:"scraperService"})," que contiene las funciones para obtener los datos."]}),"\n",(0,r.jsxs)(a.li,{children:["Definimos la clase ",(0,r.jsx)(a.code,{children:"LineController"})," con dos m\xe9todos as\xedncronos:","\n",(0,r.jsxs)(a.ul,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"getLines"}),": Maneja la petici\xf3n para obtener todas las l\xedneas de bus. Llama a ",(0,r.jsx)(a.code,{children:"scraperService.getBusLines()"})," y devuelve los datos en formato JSON."]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"getLineStops"}),": Maneja la petici\xf3n para obtener las paradas de una l\xednea espec\xedfica. Extrae el ",(0,r.jsx)(a.code,{children:"lineCode"})," de los par\xe1metros de la ruta, llama a ",(0,r.jsx)(a.code,{children:"scraperService.getLineStops(lineCode)"})," y devuelve los datos en formato JSON."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(a.li,{children:["En ambos m\xe9todos, usamos un bloque ",(0,r.jsx)(a.code,{children:"try-catch"})," para manejar errores. Si ocurre un error, lo pasamos al siguiente middleware de Express usando ",(0,r.jsx)(a.code,{children:"next(error)"}),"."]}),"\n",(0,r.jsxs)(a.li,{children:["Finalmente, exportamos una instancia de ",(0,r.jsx)(a.code,{children:"LineController"})," para que pueda ser utilizada en el router."]}),"\n"]}),"\n",(0,r.jsxs)(a.p,{children:["\xa1Ay! Se me ha olvidado comentar lo del ",(0,r.jsx)(a.strong,{children:"middleware"}),". Express tiene un sistema de manejo de errores muy sencillo. Si en un controlador llamas a ",(0,r.jsx)(a.code,{children:"next(error)"}),", Express buscar\xe1 un middleware de manejo de errores para procesar ese error. Luego veremos c\xf3mo implementarlo."]}),"\n",(0,r.jsxs)(a.p,{children:["Ahora veamos el controlador de paradas (",(0,r.jsx)(a.code,{children:"stopController.js"}),"), que maneja la petici\xf3n ",(0,r.jsx)(a.code,{children:"GET /lines/:lineCode/:stopCode"})," para obtener el tiempo de llegada del bus en una parada espec\xedfica:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers title="stopController.js"',children:"import scraperService from '../services/scraperService.js';\n\nexport class StopController {\n    async getBusArrival(req, res, next) {\n        try {\n            const { lineCode, stopCode } = req.params;\n            const busTime = await scraperService.getBusTimeAtStop(lineCode, stopCode);\n            \n            res.json({\n                success: true,\n                data: {\n                    line: lineCode,\n                    stop: stopCode,\n                    arrival_time: busTime,\n                    unit: 'minutes'\n                }\n            });\n        } catch (error) {\n            next(error);\n        }\n    }\n}\n\nexport default new StopController();\n"})}),"\n",(0,r.jsx)(a.p,{children:"Habiendo entendido el c\xf3digo anterior, este es muy similar. Aqu\xed est\xe1 el desglose:"}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:["Importamos el servicio ",(0,r.jsx)(a.code,{children:"scraperService"})," que contiene la funci\xf3n para obtener el tiempo de llegada del bus."]}),"\n",(0,r.jsxs)(a.li,{children:["Definimos la clase ",(0,r.jsx)(a.code,{children:"StopController"})," con un m\xe9todo as\xedncrono:","\n",(0,r.jsxs)(a.ul,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"getBusArrival"}),": Maneja la petici\xf3n para obtener el tiempo de llegada del bus en una parada espec\xedfica. Extrae ",(0,r.jsx)(a.code,{children:"lineCode"})," y ",(0,r.jsx)(a.code,{children:"stopCode"})," de los par\xe1metros de la ruta, llama a ",(0,r.jsx)(a.code,{children:"scraperService.getBusTimeAtStop(lineCode, stopCode)"})," y devuelve los datos en formato JSON."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(a.li,{children:["Usamos un bloque ",(0,r.jsx)(a.code,{children:"try-catch"})," para manejar errores, pasando cualquier error al siguiente middleware con ",(0,r.jsx)(a.code,{children:"next(error)"}),"."]}),"\n",(0,r.jsxs)(a.li,{children:["Finalmente, exportamos una instancia de ",(0,r.jsx)(a.code,{children:"StopController"})," para que pueda ser utilizada en el router."]}),"\n"]}),"\n",(0,r.jsx)(a.admonition,{type:"note",children:(0,r.jsx)(a.p,{children:"Al final, todos los controladores hacen siempre lo mismo: reciben la petici\xf3n, llaman al servicio para obtener los datos, y devuelven la respuesta en formato JSON. Si ocurre un error, lo pasan al middleware de manejo de errores."})}),"\n",(0,r.jsx)(a.h3,{id:"middleware-qu\xe9-diablos-es-eso",children:"Middleware (\xbfqu\xe9 diablos es eso?)"}),"\n",(0,r.jsxs)(a.p,{children:["Un middleware en Express es una funci\xf3n que tiene acceso al objeto de solicitud (",(0,r.jsx)(a.code,{children:"req"}),"), al objeto de respuesta (",(0,r.jsx)(a.code,{children:"res"}),"), y a la siguiente funci\xf3n de middleware en el ciclo de solicitud/respuesta de la aplicaci\xf3n. Los middlewares pueden ejecutar cualquier c\xf3digo, realizar cambios en la solicitud y los objetos de respuesta, finalizar el ciclo de solicitud/respuesta, o llamar a la siguiente funci\xf3n de middleware."]}),"\n",(0,r.jsxs)(a.p,{children:["Dicho de otro modo, es algo que est\xe1 entre la petici\xf3n y la respuesta. ",(0,r.jsx)(a.em,{children:"Middle"})," significa ",(0,r.jsx)(a.em,{children:"medio"})," en ingl\xe9s, y ",(0,r.jsx)(a.em,{children:"ware"})," es una abreviaci\xf3n de ",(0,r.jsx)(a.em,{children:"software"}),". As\xed que un middleware es un software que act\xfaa en medio de la petici\xf3n y la respuesta."]}),"\n",(0,r.jsx)(a.p,{children:"Nosotros vamos a definir dos middlewares:"}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.strong,{children:"Middleware de manejo de errores"}),": Para capturar cualquier error que ocurra en los controladores y devolver una respuesta adecuada."]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.strong,{children:"Middleware de logging"}),": Para registrar cada petici\xf3n que llega a la API."]}),"\n"]}),"\n",(0,r.jsx)(a.admonition,{type:"warning",children:(0,r.jsxs)(a.p,{children:["Estos no son los middlewares que utilic\xe9 en mi proyecto original. Yo us\xe9 librer\xedas externas como ",(0,r.jsx)(a.a,{href:"https://www.npmjs.com/package/morgan",children:"morgan"})," para logging y ",(0,r.jsx)(a.a,{href:"https://www.npmjs.com/package/winston",children:"winston"})," para manejo de errores. Pero para este ejemplo, he decidido escribir mis propios middlewares para que se entienda mejor c\xf3mo funcionan."]})}),"\n",(0,r.jsx)(a.h4,{id:"middleware-de-manejo-de-errores",children:"Middleware de manejo de errores"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers title="errorMiddleware.js"',children:"export function errorHandler(err, req, res, next) {\n    console.error(err.stack);\n    res.status(500).json({\n        success: false,\n        message: err.message || 'Internal Server Error'\n    });\n}\n\nexport const notFoundHandler = (req, res, next) => {\n    res.status(404).json({\n        success: false,\n        message: 'Resource not found'\n    });\n}\n"})}),"\n",(0,r.jsxs)(a.p,{children:["El middleware ",(0,r.jsx)(a.code,{children:"errorHandler"})," hace lo siguiente:"]}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:["Recibe cuatro par\xe1metros: ",(0,r.jsx)(a.code,{children:"err"}),", ",(0,r.jsx)(a.code,{children:"req"}),", ",(0,r.jsx)(a.code,{children:"res"}),", y ",(0,r.jsx)(a.code,{children:"next"}),"."]}),"\n",(0,r.jsx)(a.li,{children:"Imprime el stack trace del error en la consola para facilitar la depuraci\xf3n."}),"\n",(0,r.jsx)(a.li,{children:"Devuelve una respuesta JSON con un c\xf3digo de estado 500 (Internal Server Error) y un mensaje de error."}),"\n"]}),"\n",(0,r.jsxs)(a.p,{children:["Tambi\xe9n definimos un middleware ",(0,r.jsx)(a.code,{children:"notFoundHandler"})," para manejar rutas no encontradas, devolviendo un c\xf3digo de estado 404."]}),"\n",(0,r.jsx)(a.h4,{id:"middleware-de-logging",children:"Middleware de logging"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'showLineNumbers title="loggerMiddleware.js"',children:"export function logger(req, res, next) {\n    console.log(`${req.method} ${req.originalUrl}`);\n    next();\n}\n"})}),"\n",(0,r.jsxs)(a.p,{children:["Este middleware registra en la consola el m\xe9todo HTTP y la URL de cada petici\xf3n que llega a la API. Luego llama a ",(0,r.jsx)(a.code,{children:"next()"})," para pasar el control al siguiente middleware o ruta."]}),"\n",(0,r.jsx)(a.h3,{id:"la-aplicaci\xf3n-principal",children:"La aplicaci\xf3n principal"}),"\n",(0,r.jsxs)(a.p,{children:["Ya tenemos ",(0,r.jsx)(a.em,{children:"casi"})," todas las partes necesarias para que nuestra API funcione. Solo nos falta montar el servidor Express principal que escuche las peticiones y utilice el router que hemos definido. Lo \xfanico que queda es cargar las rutas correspondientes y configurar el middleware de manejo de errores desde el archivo principal. En mi caso, lo llamar\xe9 ",(0,r.jsx)(a.code,{children:"app.js"}),":"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'title="app.js" showLineNumbers=1',children:"import express from 'express';\nimport indexRouter from './routes/index.js';\nimport { errorHandler, notFoundHandler } from './middlewares/errorMiddleware.js';\nimport { logger } from './middlewares/loggerMiddleware.js';\n"})}),"\n",(0,r.jsxs)(a.p,{children:["Necesitamos importar Express, nuestro router principal (",(0,r.jsx)(a.code,{children:"indexRouter"}),"), y los middlewares que hemos definido (",(0,r.jsx)(a.code,{children:"errorHandler"}),", ",(0,r.jsx)(a.code,{children:"notFoundHandler"}),", y ",(0,r.jsx)(a.code,{children:"logger"}),")."]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'title="app.js" showLineNumbers=6',children:"const app = express();\nconst PORT = process.env.PORT || 3000;\n"})}),"\n",(0,r.jsx)(a.p,{children:"Aqu\xed creamos una instancia de la aplicaci\xf3n Express y definimos el puerto en el que escuchar\xe1 (usando una variable de entorno o el puerto 3000 por defecto)."}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'title="app.js" showLineNumbers=9',children:"// Middleware de logging\napp.use(logger);\n// Rutas principales\napp.use('/api', indexRouter);\n// Middleware para rutas no encontradas\napp.use(notFoundHandler);\n// Middleware de manejo de errores\napp.use(errorHandler);\n"})}),"\n",(0,r.jsx)(a.p,{children:"En esta secci\xf3n configuramos los middlewares y las rutas:"}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"app.use(logger);"})," registra cada petici\xf3n que llega."]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"app.use('/api', indexRouter);"})," monta nuestro router principal en la ruta ",(0,r.jsx)(a.code,{children:"/api"}),"."]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"app.use(notFoundHandler);"})," maneja cualquier ruta que no haya sido encontrada."]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.code,{children:"app.use(errorHandler);"})," maneja cualquier error que ocurra en los controladores."]}),"\n"]}),"\n",(0,r.jsx)(a.admonition,{type:"warning",children:(0,r.jsx)(a.p,{children:"Es muy importante el orden en el que se definen los middlewares y las rutas. Los middlewares de manejo de errores deben ir al final, despu\xe9s de todas las rutas."})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'title="app.js" showLineNumbers=18',children:"app.listen(PORT, () => {\n    console.log(`Server is running on http://localhost:${PORT}/api`);\n});\n"})}),"\n",(0,r.jsx)(a.p,{children:"Finalmente, iniciamos el servidor para que escuche en el puerto definido y mostramos un mensaje en la consola indicando que el servidor est\xe1 funcionando."}),"\n",(0,r.jsxs)(a.p,{children:["El archivo completo ",(0,r.jsx)(a.code,{children:"app.js"})," queda as\xed:"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",metastring:'title="app.js" showLineNumbers',children:"import express from 'express';\nimport indexRouter from './routes/index.js';\nimport { errorHandler, notFoundHandler } from './middlewares/errorMiddleware.js';\nimport { logger } from './middlewares/loggerMiddleware.js';\n\nconst app = express();\nconst PORT = process.env.PORT || 3000;\n\n// Middleware de logging\napp.use(logger);\n// Rutas principales\napp.use('/api', indexRouter);\n// Middleware para rutas no encontradas\napp.use(notFoundHandler);\n// Middleware de manejo de errores\napp.use(errorHandler);\n\napp.listen(PORT, () => {\n    console.log(`Server is running on http://localhost:${PORT}/api`);\n});\n"})}),"\n",(0,r.jsx)(a.h3,{id:"probando-la-api",children:"Probando la API"}),"\n",(0,r.jsx)(a.p,{children:"Y con esto, nuestra API est\xe1 completa y lista para usarse. Podemos hacer peticiones a los endpoints definidos para obtener las l\xedneas de bus, las paradas de una l\xednea espec\xedfica, y los tiempos de llegada en tiempo real."}),"\n",(0,r.jsxs)(a.p,{children:["Por ejemplo, podemos usar ",(0,r.jsx)(a.code,{children:"curl"})," o ",(0,r.jsx)(a.a,{href:"https://insomnia.rest/",children:"Insomnia"})," para probar los endpoints:"]}),"\n",(0,r.jsxs)(a.p,{children:["Os dejo una captura de pantalla de Insomnia haciendo una petici\xf3n a ",(0,r.jsx)(a.code,{children:"GET /api/lines/05/34"})," para obtener el tiempo de llegada del bus en la parada 34 de la l\xednea 05:"]}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{alt:"Cliente de Insomnia realizando una petici\xf3n GET /api/lines/05/34",src:n(6e3).A+"",width:"2050",height:"1166"})}),"\n",(0,r.jsxs)(a.p,{children:["Se puede apreciar que el tiempo de respuesta ha sido de ",(0,r.jsx)(a.strong,{children:"3.94 segundos"}),". Todo este tiempo es simplemente porque usamos Puppeteer."]}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{alt:"Cliente de Insomnia realizando una petici\xf3n GET /api/lines/05/34 por segunda vez",src:n(1403).A+"",width:"2050",height:"1166"})}),"\n",(0,r.jsxs)(a.p,{children:["Al hacer una nueva petici\xf3n, el tiempo de respuesta ",(0,r.jsx)(a.strong,{children:"baja a 496 ms"}),". Os preguntar\xe9is por qu\xe9. Como lanzar Puppeteer es costoso, decid\xed ",(0,r.jsx)(a.strong,{children:"a\xf1adir una cach\xe9"})," para almacenar las paradas de una l\xednea ",(0,r.jsx)(a.strong,{children:"durante 1h"}),", junto con el c\xf3digo de seguridad. As\xed, si se hacen m\xfaltiples peticiones a la misma l\xednea en un corto per\xedodo de tiempo, no es necesario volver a abrir el navegador y cargar la p\xe1gina completa."]}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{alt:"Cliente de Insomnia realizando una petici\xf3n GET /api/lines/ una vez cacheadas las l\xedneas",src:n(7746).A+"",width:"2050",height:"1166"})}),"\n",(0,r.jsxs)(a.p,{children:["En el caso de las l\xedneas y las paradas, esto baja el tiempo de respuesta a ",(0,r.jsx)(a.strong,{children:"menos de 20 ms"}),". \xa1Nada mal! Recordemos que para los tiempos de llegada tenemos que hacer la petici\xf3n AJAX cada vez, as\xed que es tiempo extra que no podemos evitar."]}),"\n",(0,r.jsx)(a.h2,{id:"tercera-fase-notificaciones-en-el-m\xf3vil",children:"Tercera fase: Notificaciones en el m\xf3vil"}),"\n",(0,r.jsx)(a.p,{children:"\xa1YA CASI ESTAMOS! Hemos conseguido crear una API que nos da la informaci\xf3n en tiempo real de las l\xedneas de bus de Donosti. Ahora solo falta crear un programa que est\xe9 pendiente de esa API y nos avise cuando el bus est\xe9 cerca de nuestra parada."}),"\n",(0,r.jsx)(a.p,{children:"En mi caso, tengo algo de experiencia programando bots para Discord, as\xed que decid\xed tomar ese camino. Aun as\xed, no entrar\xe9 en detalles de la implementaci\xf3n, que ya se me ha hecho demasiado largo este post. Os ense\xf1o los resultados para que ve\xe1is que tiene una aplicaci\xf3n pr\xe1ctica real."}),"\n",(0,r.jsx)(a.h3,{id:"consultar-la-api-desde-el-bot",children:"Consultar la API desde el bot"}),"\n",(0,r.jsx)("video",{src:l.A,autoPlay:!0,muted:!0,loop:!0,controls:!0,style:{maxWidth:"100%",height:"auto"}}),"\n",(0,r.jsx)(a.h3,{id:"recibiendo-las-notificaciones",children:"Recibiendo las notificaciones"}),"\n",(0,r.jsx)(a.p,{children:"Como con cualquier otro mensaje de Discord, me llegan las notificaciones al m\xf3vil a trav\xe9s de la app. Funcionar\xeda exactamente igual si usara Telegram, WhatsApp, o cualquier otra plataforma que soporte bots."}),"\n",(0,r.jsx)("video",{src:t.A,autoPlay:!0,muted:!0,loop:!0,controls:!0,style:{maxWidth:"50%",height:"auto"}}),"\n",(0,r.jsx)(a.p,{children:"Tengo las notificaciones del m\xf3vil conectadas al reloj, por lo que tambi\xe9n me vibra la mu\xf1eca para avisarme (bastante \xfatil si estoy en clase y no siento la vibraci\xf3n del m\xf3vil)."}),"\n",(0,r.jsx)("img",{src:n(1933).A,alt:"Foto de mi reloj inteligente recibiendo la notificaci\xf3n de la llegada del bus",style:{maxWidth:"50%",height:"auto"}}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsxs)(a.em,{children:["Perdonad la mala calidad de la imagen ",(0,r.jsx)(a.code,{children:":P"})]})}),"\n",(0,r.jsx)(a.h2,{id:"conclusi\xf3n",children:"Conclusi\xf3n"}),"\n",(0,r.jsx)(a.p,{children:"Y hasta aqu\xed la entrada. Despu\xe9s de esto, os habr\xe9is hecho una idea general de c\xf3mo me met\xed en las tripas de la p\xe1gina web de d\xb7bus para extraer la informaci\xf3n que necesitaba, y c\xf3mo mont\xe9 una API sencilla para finalmente crear un bot que la consumiera."}),"\n",(0,r.jsxs)(a.p,{children:["De todo esto, tambi\xe9n me gustar\xeda sacar una ",(0,r.jsx)(a.strong,{children:"peque\xf1a reflexi\xf3n."})]}),"\n",(0,r.jsx)(a.h3,{id:"sobre-la-falta-de-una-api-oficial",children:"Sobre la falta de una API oficial"}),"\n",(0,r.jsx)(a.p,{children:"Los datos sobre las l\xedneas, paradas y tiempos de llegada est\xe1n p\xfablicamente disponibles para cualquier usuario que visite la web de d\xb7bus. Sin embargo, no existe una API oficial para acceder a estos datos."}),"\n",(0,r.jsx)(a.p,{children:"Lo ideal ser\xeda que la propia empresa de transporte p\xfablico ofreciera una API bien documentada y accesible para que todos los ciudadanos podamos usarla libremente. Esto fomentar\xeda la creaci\xf3n de aplicaciones y servicios que mejoren la experiencia de los usuarios, como apps de seguimiento en tiempo real, alertas personalizadas, y mucho m\xe1s."}),"\n",(0,r.jsxs)(a.p,{children:["Y, en caso de no querer ofrecerla, deber\xedan echar un vistazo a c\xf3mo ",(0,r.jsx)(a.strong,{children:"autentican"})," las peticiones AJAX. Porque, como hemos visto, hemos conseguido acceso a los datos sin ning\xfan tipo de autenticaci\xf3n, simplemente inspeccionando el c\xf3digo fuente y replicando las peticiones."]}),"\n",(0,r.jsx)(a.h3,{id:"gracias-joseba",children:"Gracias Joseba"}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.em,{children:"Joseba, si est\xe1s leyendo esto, eres el puto amo."})}),"\n",(0,r.jsx)(a.p,{children:"Ahora os doy un poco de contexto."}),"\n",(0,r.jsx)(a.p,{children:"Cuando empec\xe9 a leerme el c\xf3digo fuente de la p\xe1gina de d\xb7bus y a buscar c\xf3mo extraer los datos, me encontr\xe9 con estos comentarios repartidos por ah\xed:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-javascript",children:"//A\xf1adido por Joseba\n//Modificado por Joseba he a\xf1adido al enlace clase id y mid para luego manejarlo con jQuery\n//Evento a\xf1adido por Joseba para manejar los favoritos\n//variables a\xf1adidas por Joseba para gestionar el plugin\n//A\xf1adido por Joseba: Genero el par mapa categoria para filtrar\n//Funcion a\xf1adida por Joseba para controlar los puntos\n//A\xf1adido por Joseba para el data layer\n//Evento a\xf1adido por Joseba para manejar las paradas\n//Funci\xf3n creada por Joseba para meter el mapa en los tabuladores\n//Modificado por Joseba para que el mapa empiece en blanco\n//A\xf1adido por Joseba para los ptos turisticos\n//A\xf1adido por Joseba PAra tratar paradas duplicadas\n//Modificado por Joseba he a\xf1adido al enlace clase id y mid para luego manejarlo con jQuery\n//A\xf1adido por Joseba para eliminar los mensajes relacionados con las paradas\n"})}),"\n",(0,r.jsxs)(a.p,{children:["Me hac\xeda demasiada gracia encontrarme a Joseba cada dos por tres. ",(0,r.jsx)(a.code,{children:"\xaf\\_(\u30c4)_/\xaf"})]}),"\n",(0,r.jsx)(a.hr,{}),"\n",(0,r.jsxs)(a.p,{children:["Y ahora s\xed que s\xed, esto es todo por hoy. Espero que os haya gustado este largo viaje por el mundo del ",(0,r.jsx)(a.strong,{children:"web scraping"}),", ",(0,r.jsx)(a.strong,{children:"Puppeteer"}),", y la creaci\xf3n de APIs con ",(0,r.jsx)(a.strong,{children:"Express.js"}),"."]}),"\n",(0,r.jsxs)(a.p,{children:["Pod\xe9is encontrar el ",(0,r.jsx)(a.strong,{children:"c\xf3digo completo de este proyecto"})," en ",(0,r.jsx)(a.a,{href:"https://github.com/GlutenFreeSoftware/dbus-api",children:"este repositorio de GitHub"}),"."]}),"\n",(0,r.jsxs)(a.p,{children:["Tambi\xe9n pod\xe9is encontrar el ",(0,r.jsx)(a.strong,{children:"bot de Discord"})," en ",(0,r.jsx)(a.a,{href:"https://github.com/KingJorjai/dbus-bot",children:"este otro repositorio"}),"."]}),"\n",(0,r.jsx)(a.hr,{}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.strong,{children:"\xa1Nos vemos en la pr\xf3xima entrada del blog!"})})]})}function h(e={}){const{wrapper:a}={...(0,o.R)(),...e.components};return a?(0,r.jsx)(a,{...e,children:(0,r.jsx)(m,{...e})}):m(e)}},5765:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/medias/notificacion-movil-65c89f2de7512eb5776ece09e2b52e60.mp4"},6e3:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/insomnia-1-445ea26ec8f4ecf8798fee719106082e.png"},7746:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/insomnia-3-b3faa1f88b4de139006a981cbb0654c7.png"},8453:(e,a,n)=>{n.d(a,{R:()=>i,x:()=>l});var s=n(6540);const r={},o=s.createContext(r);function i(e){const a=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function l(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:a},e.children)}}}]);