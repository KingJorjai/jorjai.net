"use strict";(globalThis.webpackChunkctf_writeups=globalThis.webpackChunkctf_writeups||[]).push([[54],{59:(e,n,a)=>{a.d(n,{A:()=>r});const r=a.p+"assets/files/logica_doble_valor-14d44e27beedbfd09fbd9f87ef872931.zip"},1803:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"ikerlan-ctf/400/logica-doble-valor/logica-doble-valor","title":"L\xf3gica doble valor (400)","description":"La p\xe1gina tiene un buscador con un filtro de seguridad muy estricto. Parece que no te deja buscar nada sensible. Sin embargo, hay un peque\xf1o fallo de l\xf3gica en la forma en que el servidor procesa tu petici\xf3n. \xbfPuedes enga\xf1ar al filtro y hacer que busque la flag sin que se d\xe9 cuenta?","source":"@site/docs/ikerlan-ctf/400/logica-doble-valor/logica-doble-valor.mdx","sourceDirName":"ikerlan-ctf/400/logica-doble-valor","slug":"/ikerlan-ctf/400/logica-doble-valor/","permalink":"/docs/ikerlan-ctf/400/logica-doble-valor/","draft":false,"unlisted":false,"editUrl":"https://github.com/KingJorjai/jorjai.net/tree/main/packages/create-docusaurus/templates/shared/docs/ikerlan-ctf/400/logica-doble-valor/logica-doble-valor.mdx","tags":[],"version":"current","frontMatter":{"title":"L\xf3gica doble valor (400)"},"sidebar":"ctfWriteupsSidebar","previous":{"title":"El or\xe1culo cegado (400)","permalink":"/docs/ikerlan-ctf/400/el-oraculo-cegado/"},"next":{"title":"Python Jail v2.0 - Maximum Security (400)","permalink":"/docs/ikerlan-ctf/400/python-jail-v2.0-maximum-security/"}}');var s=a(4848),i=a(8453);const o={title:"L\xf3gica doble valor (400)"},l=void 0,t={},c=[{value:"An\xe1lisis inicial",id:"an\xe1lisis-inicial",level:2},{value:"Examinando el c\xf3digo fuente",id:"examinando-el-c\xf3digo-fuente",level:2},{value:"Explotaci\xf3n",id:"explotaci\xf3n",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"La p\xe1gina tiene un buscador con un filtro de seguridad muy estricto. Parece que no te deja buscar nada sensible. Sin embargo, hay un peque\xf1o fallo de l\xf3gica en la forma en que el servidor procesa tu petici\xf3n. \xbfPuedes enga\xf1ar al filtro y hacer que busque la flag sin que se d\xe9 cuenta?"}),"\n",(0,s.jsx)(n.p,{children:"La flag est\xe1 en /flag.txt"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:a(59).A+"",children:"Descargar contenedor Docker del desaf\xedo"})}),"\n",(0,s.jsx)(n.h2,{id:"an\xe1lisis-inicial",children:"An\xe1lisis inicial"}),"\n",(0,s.jsx)(n.p,{children:"Se nos presenta una p\xe1gina web con un campo de b\xfasqueda."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"P\xe1gina principal",src:a(8094).A+"",width:"1920",height:"1134"})}),"\n",(0,s.jsxs)(n.p,{children:["Seg\xfan el mensaje, la flag est\xe1 en ",(0,s.jsx)(n.code,{children:"/flag.txt"}),". Voy a ver qu\xe9 pasa si intento buscar ese archivo directamente."]}),"\n",(0,s.jsxs)(n.p,{children:["Recibimos el siguiente error:\n",(0,s.jsx)(n.code,{children:"Consulta inv\xe1lida. Has usado una palabra prohibida."})]}),"\n",(0,s.jsx)(n.h2,{id:"examinando-el-c\xf3digo-fuente",children:"Examinando el c\xf3digo fuente"}),"\n",(0,s.jsx)(n.p,{children:"Vamos a ver la estructura del servidor."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tree",metastring:'title="$ tree"',children:".\n\u251c\u2500\u2500 app.js\n\u251c\u2500\u2500 docker-compose.yml\n\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 flag.txt\n\u251c\u2500\u2500 index.html\n\u2514\u2500\u2500 style.css\n"})}),"\n",(0,s.jsxs)(n.p,{children:["El archivo ",(0,s.jsx)(n.code,{children:"app.js"})," es el servidor web. Vamos a ver su contenido."]}),"\n",(0,s.jsx)(n.p,{children:"La siguiente funci\xf3n comprueba si en el texto pasado como par\xe1metro hay alguna palabra prohibida:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",metastring:'title="app.js" showLineNumbers=10',children:"const is_safe = (input) => {\n    const forbidden_words = ['flag', 'etc', 'passwd', '..', '/', '%'];\n    for (const word of forbidden_words) {\n        if (input.includes(word)) {\n            console.log(`Petici\xf3n bloqueada por la palabra clave: ${word}`);\n            return false;\n        }\n    }\n    return true;\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\xbfDesde d\xf3nde se llama a esta funci\xf3n? Revisando el c\xf3digo, vemos que se utiliza en la ruta ",(0,s.jsx)(n.code,{children:"/search"})," para filtrar las consultas de b\xfasqueda:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",metastring:'title="app.js" showLineNumbers=29',children:'app.get(\'/search\', (req, res) => {\n    const search_query = req.query.q;\n\n    if (!search_query || search_query.length === 0) {\n        return res.status(400).send("No se proporcion\xf3 una consulta de b\xfasqueda.");\n    }\n\n    // highlight-next-line\n    if (!is_safe(search_query)) {\n        return res.status(403).send("Consulta inv\xe1lida. Has usado una palabra prohibida.");\n    }\n    \n    const all_queries = req.query.q;\n    \n    // highlight-start\n    if (Array.isArray(all_queries) && all_queries.length > 1) {\n        const file_path = all_queries.join("");\n    // highlight-end\n\n        try {\n            const content = fs.readFileSync(file_path, \'utf8\');\n            return res.status(200).send(`Contenido encontrado: <br><br> ${content}`);\n        } catch (error) {\n            console.log(error);\n            return res.status(404).send("Archivo no encontrado.");\n        }\n    } else {\n        return res.send(`B\xfasqueda: "${search_query}"`);\n    }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:"Aqu\xed vemos que si la consulta de b\xfasqueda es un array con m\xe1s de un elemento, el servidor une todos los elementos para formar una ruta de archivo y luego intenta leer ese archivo. Sin embargo, el filtro de seguridad solo se aplica a la consulta de b\xfasqueda original y no a la ruta del archivo resultante. Esto significa que podemos aprovechar esta l\xf3gica para acceder a archivos restringidos."}),"\n",(0,s.jsx)(n.h2,{id:"explotaci\xf3n",children:"Explotaci\xf3n"}),"\n",(0,s.jsx)(n.p,{children:"Para explotar esta vulnerabilidad, podemos enviar una consulta de b\xfasqueda que contenga m\xfaltiples elementos, donde uno de ellos sea un valor seguro y el otro sea la ruta del archivo que queremos leer. Por ejemplo, podr\xedamos enviar la siguiente consulta:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/search?q=/fla&q=g.txt\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Esto deber\xeda permitirnos eludir el filtro de seguridad y acceder al contenido de ",(0,s.jsx)(n.code,{children:"/flag.txt"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"ikerlan{el_filtro_no_ve_doble}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8094:(e,n,a)=>{a.d(n,{A:()=>r});const r=a.p+"assets/images/landing-be3c2a6468c19fd57c546d8a118631ae.png"},8453:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>l});var r=a(6540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);